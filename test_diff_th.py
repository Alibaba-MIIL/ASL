import os
import torch
from src.helper_functions.helper_functions import parse_args
from src.loss_functions.losses import AsymmetricLoss, AsymmetricLossOptimized
from src.models import create_model
import argparse
import matplotlib
import torchvision.transforms as transforms
# matplotlib.use('TkAgg')
import matplotlib.pyplot as plt
from PIL import Image
import numpy as np
from attacks import pgd, fgsm, mi_fgsm, get_weight_distribution
from sklearn.metrics import auc
from src.helper_functions.helper_functions import mAP, CocoDetection, CocoDetectionFiltered, CutoutPIL, ModelEma, add_weight_decay
from src.helper_functions.voc import Voc2007Classification
from create_model import create_q2l_model
from src.helper_functions.nuswide_asl import NusWideFiltered

rankings = [0, 58, 74, 39, 16, 2, 56, 7, 73, 41, 27, 24, 25, 15, 49, 71, 40, 60, 26, 1, 57, 11, 62, 51, 
    8, 5, 13, 59, 46, 63, 9, 45, 75, 14, 55, 17, 3, 53, 67, 77, 28, 76, 69, 50, 68, 32, 44, 48,
    72, 18, 65, 21, 54, 10, 6, 43, 20, 47, 61, 36, 19, 52, 42, 33, 22, 12, 66, 79, 38, 37, 35, 23, 4, 31, 34, 29, 64, 30, 78, 70]

flips_asl_coco_bce = [0.,    1.52,  3.47,  4.5,   5.6,   6.79,  7.65,  8.5,   9.62, 10.55, 11.45,
  12.25, 13.,   13.65, 14.03, 14.7,  14.83, 15.45, 15.63, 16.  , 16.  , 16.42, 16.21,
  16.56, 16.74, 16.84, 16.81, 17.1,  17.22, 17.34, 17.66, 17.66, 17.91, 18.25, 18.03,
  18.34, 18.57, 18.29, 18.53, 18.74, 18.79, 19.07, 19.08, 19.16, 19.29, 19.45, 19.47,
  19.65, 19.98, 20.15, 19.94, 19.99, 20.07, 20.21, 19.74, 19.82, 19.99, 19.78, 20.,
  19.93, 19.61, 19.52, 19.58, 19.36, 19.18 ,18.97, 18.51, 18.47, 18.36, 18.41, 18.46,
  18.29, 18.05, 18.  , 17.97, 17.73, 17.77, 17.66, 17.42, 17.45, 17.1, ]

flips_asl_coco_bce_random = [ 0. ,   3.24,4.55,  5.5 ,  7.04,  8.08,  8.4 ,  9.54, 10.22, 10.23, 10.37, 10.68,
  12.06, 11.78, 11.5,  12.36, 12.93, 12.85, 12.78, 13.89, 12.94, 13.45, 13.81, 14.07,
  14.38, 13.61, 13.52, 14.11, 13.2  ,14.9 , 14.25, 14.84, 14.66, 14.61, 14.61, 14.19,
  14.81, 14.52, 14.93 ,15.01, 14.79 ,15.26, 14.71, 15.  , 14.35, 15.6 , 15.56, 14.66,
  14.87 ,14.67, 14.8 , 15.17, 14.92 ,15.11, 15.8 , 15.09, 14.92, 15.21, 15.13, 15.52,
  15.13 ,14.99, 15.39 ,15.53, 15.48, 15.36, 15.33, 15.26, 15.5 , 15.57, 15.58, 15.76,
  15.27 ,15.38, 15.5  ,15.19, 15.36, 15.59, 15.35, 15.26, 15.44,]

flips_asl_coco_hybrid_loss = [ 0.,    1.52,  3.21,  4.19,  5.07,  6.12,  6.81,   7.45,  8.1,   8.83,  9.53 ,10.03,
  10.62, 11.44, 11.86, 12.52, 12.75, 13.34 , 13.65, 14.05, 14.36, 14.72, 14.89,  15.55,
  15.74, 16.07, 16.21, 16.46, 16.75, 17.26 , 17.41, 17.81, 18.14, 18.41, 18.64,  18.92,
  19.02, 19.18, 19.46, 19.74, 19.98, 20.4  , 20.51, 20.61, 20.66, 21.05, 21.5 ,  21.77,
  21.98, 22.24, 22.3 , 22.47, 22.69, 22.8  , 22.85, 22.72, 23.05, 22.99, 23.1 ,  23.16,
  23.31, 23.23, 23.47, 23.64, 23.58, 23.59 , 23.51, 23.56, 23.34, 23.45,  23.62,  23.62,
  23.56, 23.6 , 23.73, 23.47, 23.52, 23.44 , 23.55, 23.48, 23.44,]


flips_q2l_coco_hybrid_loss = [ 0, 2.4, 3.6, 4.4, 5.8, 5.6, 6.2, 7.4, 7.8, 8, 8.6, 8.8, 9.8, 9,
  10.2, 10.4, 10.2, 10.4, 10.8, 11.4, 11.6, 11.6, 12.2, 12.4, 12. , 12.8, 12.4, 12.8,
  12.8, 13.2, 13.4, 13.4, 13.4, 14.4, 13.8, 13.6, 14.4, 14. , 14.6, 14.2, 14.8, 14.6,
  14.8, 14.4, 15.2, 14.8, 14.8, 14.6, 14.4, 14.4, 14.8, 14.6, 15.8, 14.6, 14.6, 15.2,
  14. , 15.6, 15.2, 14.6, 16. , 14.4, 15. , 15. , 15.8, 15.2, 15.8, 15.2, 15.4, 16.2,
  15.8, 15.8, 15.2, 15.4, 15.2, 15.6, 16. , 16. , 15.6, 15.4, 15.6,]

flips_q2l_coco_bce = [0.4, 1.4,  2.6,  3.6,  4.2,  5.4,  6.2,  7,   8.2,  8.8,  9.8, 10.4, 11,  11.6,
  11.4, 12.2, 12. , 12. , 13. , 13.6, 13.2, 14. , 13.4, 14.8, 14.6, 14. , 14.6, 14.8,
  14.2, 13.2, 13.6, 14. , 13.4, 14.8, 13.4, 14.2, 14. , 10.8, 12.4, 12.2, 12.2, 13.4,
  12.6, 11.4, 11.4, 11.6, 11.4, 10.6, 10.8, 10.6, 10.8, 10.8, 10.4, 10.6, 10. , 10.4,
   9.2,  9.6, 10.4,  9.2,  9.6,  9.8,  8.4, 10. ,  9.4,  9.4,  8.8,  9.8,  8. ,  8.6,
   8.4,  7.8,  8.2,  7.8,  7.4,  7.8,  7.4,  6.6,  6.8,  6.6,  7. ]

flips_q2l_coco_bce_random = [ 0.2,  2.6,  2.8,  4. ,  5.4,  5.6,  7.4,  6.8,  8.6,  7.6,  8.6,  8.8,  9.2,  7.8,
   9.6,  9.6,  8.6,  8.8,  9.2,  9. , 10.8, 12.2, 11.8,  8.2,  11.,  9.4, 10.8,  9.,
  10.4,  8.6, 11.4, 11. , 10.6, 12. ,  9.8,  9.4, 10.6, 10. ,  9.6,  11.,   9.8,  9.6,
   8.2, 11.4, 10.6, 11.4, 10.6,  8.4,  8.2,  9. , 10.6,  9.6,  8.6,  11.4,  9.8, 11.4,
   9. ,  9.2,  9.2,  9.4, 10.2, 10.4,  8.8,  9.2, 10.2,  9.8,  9.6,  9.6, 10.6,  9.4,
  10.4,  9.6, 10.6, 10. ,  9.4,  8.8, 10. , 10.4,  8.4, 9.6 ,  10.2,]




plt.plot(range(81), flips_q2l_coco_bce_random, label='BCELoss random-n-labels')
plt.plot(range(81), flips_q2l_coco_bce, label='BCEloss top-n-labels')
plt.plot(range(81), flips_q2l_coco_hybrid_loss, label='hybrid loss top-n-labels')
plt.xlabel("number of attempted flips")
plt.ylabel("number of  flips")
plt.title("Q2L, MSCOCO_2014, MI-FGSM")
plt.legend()
plt.show()

